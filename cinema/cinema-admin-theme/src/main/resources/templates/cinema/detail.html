<!DOCTYPE html>
<html lang="en" th:replace="~{layout/layout :: layout(~{:: title}, ~{:: #css}, ~{:: .content-index}, ~{:: #js})}"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Admin Movie [[${cinema.name}]]</title>

    <th:block id="css">
        <link href="/plugins/select2/css/select2.min.css" rel="stylesheet"/>
        <link href="/dist/css/style.css" rel="stylesheet">
    </th:block>

</head>

<body class="hold-transition sidebar-mini layout-fixed">
<div class="notyf" style="justify-content: flex-start; align-items: flex-end;"></div>
<div class="wrapper">
    <!-- Content Wrapper. Contains page content -->
    <div class="content-index">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <nav class="col-sm-12">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/admin">Dashboard</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="/admin/cinema">Danh sách Rạp</a>
                            </li>
                            <li class="breadcrumb-item active">
                                [[${cinema.name}]]
                            </li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row py-2">
                    <div class="col-6">
                        <a class="btn btn-default" href="/admin/cinema">
                            <i class="fas fa-chevron-left"></i> Quay lại
                        </a>
                        <button class="btn btn-info px-4" id="btn-update" type="button">
                            Lưu
                        </button>
                    </div>
                    <div class="col-6 d-flex justify-content-end">
                        <button class="btn btn-danger px-4" data-bs-target="#centeredModalDanger" data-bs-toggle="modal"
                                th:if="${cinema.deleted == false}" type="button">
                            Xóa
                        </button>
                        <button class="btn btn-primary px-4" data-bs-target="#centeredModalPrimary"
                                data-bs-toggle="modal"
                                th:if="${cinema.deleted == true}" type="button">
                            Khôi phục
                        </button>
                    </div>
                </div>
                <div aria-hidden="true" class="modal fade" id="centeredModalDanger" style="display: none;"
                     tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered px-5" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title text-center">Xác nhận xóa rạp: [[${cinema.name}]]</h4>
                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                        type="button"></button>
                            </div>
                            <div class="modal-body m-3 text-center">
                                <h4 class="mb-0">Bạn chắc chắn muốn xóa rạp này?</h4>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Hủy</button>
                                <button class="btn btn-danger" id="delete-cinema" type="button">Xác nhận xóa</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div aria-hidden="true" class="modal fade" id="centeredModalPrimary" style="display: none;"
                     tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered px-5" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title text-center">Xác nhận khôi phục rạp: [[${cinema.name}]]</h4>
                                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal"
                                        type="button"></button>
                            </div>
                            <div class="modal-body m-3 text-center">
                                <h4 class="mb-0">Bạn chắc chắn muốn khôi phục bộ rạp này?</h4>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Hủy</button>
                                <button class="btn btn-primary" id="restore-cinema" type="button">Khôi phục</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header pb-0">
                            <h5 class="card-title">Thông tin rạp chiếu</h5>
                        </div>
                        <div class="card-body pt-0">
                            <form id="form-cinema">
                                <div class="row">
                                    <div class="col-md-8 ">
                                        <div class="form-group">
                                            <label for="name">Tên Rạp</label>
                                            <input class="form-control" id="name" name="name"
                                                   th:value="${cinema.name}"
                                                   type="text"/>
                                        </div>
                                        <div class="form-group mt-3">
                                            <label for="address">Địa chỉ</label>
                                            <textarea class="form-control" id="address" name="address"
                                                      rows="4" th:text="${cinema.address}"></textarea>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="status">Trạng thái</label>
                                            <select class="form-control" id="status" name="status">
                                                <option th:selected="${!cinema.enabled}" value="0">
                                                    Nháp
                                                </option>
                                                <option th:selected="${cinema.enabled}" value="1">
                                                    Công khai
                                                </option>
                                            </select>
                                        </div>
                                        <div class="form-group mt-3">
                                            <label for="city">Thành Phố</label>
                                            <select class="form-control" id="city" name="city">
                                                <option th:each="city : ${cities}"
                                                        th:value="${city.id}"
                                                        th:text="${city.name}"
                                                        th:selected="${cinema.city == city}"></option>
                                            </select>
                                        </div>
                                        <div class="d-flex mt-3">
                                            <div class="form-group ">
                                                <label for="lat">Vĩ độ</label>
                                                <input class="form-control" id="lat" name="lat"
                                                       th:value="${cinema.lat}"
                                                       type="text">
                                            </div>
                                            <div class="ms-4 form-group ">
                                                <label for="lng">Kinh độ</label>
                                                <input class="form-control" id="lng" name="lng"
                                                       th:value="${cinema.lng}"
                                                       type="text">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-xxl-8">
                    <div class="card">
                        <div class="card-header pb-0">
                            <h5 class="card-title">Danh sách phòng chiếu</h5>
                        </div>
                        <div class="card-body pt-0">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th style="width:40%;">Tên Phòng</th>
                                    <th style="width:25%">Loại Phòng Chiếu</th>
                                    <th class="d-none d-md-table-cell" style="width:25%">Trạng thái</th>
                                    <th>Edit</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="item : ${auditoriums}">
                                    <td th:text="${item.name}"></td>
                                    <td th:text="${item.auditoriumType}"></td>
                                    <td th:text="${item.enabled ? 'Công khai' : 'Nháp'}">Công khai</td>
                                    <td class="table-action text-center">
                                        <a  th:attr="data-aud-id=${item.id}" onclick="editAud(this)">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2 align-middle"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></a>
                                        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash align-middle"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal fade" id="auditoriumModal" tabindex="-1" aria-hidden="true" style="display: none;">
                        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h4 class=" modal-title">Thông tin rạp </h4>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body m-3">
                                    <form id="form-aud">
                                        <div class="form-group">
                                            <label for="aud-name">Tên Rạp</label>
                                            <input class="form-control" id="aud-name"
                                                   name="aud-name"
                                                   type="text"/>
                                        </div>
                                        <div class="form-group mt-2">
                                            <label for="adu-status">Trạng Thái</label>
                                            <select class="form-control" id="adu-status" name="adu-status">
                                                <option value="0">
                                                    Nháp
                                                </option>
                                                <option value="1">
                                                    Công khai
                                                </option>
                                            </select>
                                        </div>

                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                    <button type="button" class="btn btn-primary">Lưu Thay Đổi</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xxl-4">
                    <div class="card">
                        <div class="card-header pb-0">
                            <h5 class="card-title">Thông tin ghế</h5>
                        </div>
                        <div class="card-body pt-0">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th class="text-center">Tổng số cột ghế</th>
                                    <th class="text-center">Tổng số hàng ghế</th>
                                    <th class="text-center">Edit</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="item : ${auditoriums}">
                                    <td class="text-center">
                                        [[${item.totalRowChair}]]
                                    </td>
                                    <td class="text-center">[[${item.totalColumnChair}]]</td>
                                    <td class="table-action text-center">
                                        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2 align-middle"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></a>
                                        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash align-middle"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></a>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<th:block id="js">
    <!-- AdminLTE App -->
    <script src="/plugins/select2/js/select2.full.js"></script>

    <!-- Validation -->
    <script crossorigin="anonymous"
            integrity="sha512-WMEKGZ7L5LWgaPeJtw9MBM4i5w5OSBlSjTjCtSnvFJGSVD26gE5+Td12qN5pvWXhuWaWcVwF++F7aqu9cvqP0A=="
            referrerpolicy="no-referrer"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.20.0/jquery.validate.min.js"></script>
    <script crossorigin="anonymous"
            integrity="sha512-TiQST7x/0aMjgVTcep29gi+q5Lk5gVTUPE9XgN0g96rwtjEjLpod4mlBRKWHeBcvGBAEvJBmfDqh2hfMMmg+5A=="
            referrerpolicy="no-referrer"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.20.0/additional-methods.min.js"></script>

    <script th:inline="javascript">
        const cinema = [[${cinema}]];
        const auditoriums = [[${auditoriums}]];

        document.getElementById('btn-update').addEventListener("click", async (e) => {
            if (!$('#form-cinema').valid()) return;
            try {
                await axios.put(`/admin/api/v1/cinema/${cinema.id}`, getData());
                toastShow("Cập nhật thông tin rạp thành công", "success");
            } catch (error) {
                toastShow(error.response.data.message, "error");
                console.error(error);
            }
        });

        function getData() {
            return data = {
                name: $('#name').val(),
                address: $('#address').val(),
                enabled: parseInt($('#status').val(), 10) === 1,
                city: $('#city').val(),
                lng: parseFloat($('#lng').val()),
                lat: parseFloat($('#lat').val()),
            }
        }
    </script>
    <script type="text/javascript">
        function editAud(button) {
            const id = button.getAttribute('data-aud-id')
            const aud = auditoriums.filter(e => e.id.toString() === id.toString());

            $('#auditoriumModal').modal('show');
        }
    </script>
    <script type="text/javascript">
        $('#form-cinema').validate({
            rules: {
                name: { required: true },
                address: { required: true},
                lng: { required: true},
                lat: { required: true},
            },
            messages: {
                name: { required: "Vui lòng nhập tên phim" },
                address: { required: "Vui lòng nhập địa chỉ"},
                lng: { required: "Vui lòng nhập vị trí theo kinh độ" },
                lat: { required: "Vui lòng nhập vị trí theo vĩ độ" },
            },
            errorElement: 'span',
            errorPlacement: function (error, element) {
                error.addClass('invalid-feedback');
                element.closest('.form-group').append(error);
            },
            highlight: function (element) {
                $(element).addClass('is-invalid');
            },
            unhighlight: function (element) {
                $(element).removeClass('is-invalid');
            }
        });

        // delete
        document.getElementById("delete-cinema").addEventListener("click", async () => {
            try {
                const res = await axios.delete(`/admin/api/v1/cinema/${cinema.id}`)
                toastShow(`Đã xóa phim ${cinema.name}`, "success")
                setTimeout(() => {
                    window.location.href = "/admin/cinema";
                }, 1500)
            } catch (error) {
                console.log(error)
                toastShow(error.response.data.message, "error");
            }
        })

        // restore
        document.getElementById("restore-cinema").addEventListener("click", async () => {
            try {
                const res = await axios.put(`/admin/api/v1/cinema/restore/${cinema.id}`)
                toastShow(`Đã khôi phục phim ${cinema.name}`, "success")
                setTimeout(() => {
                    window.location.href = "/admin/cinema?data=delete";
                }, 1000)
            } catch (error) {
                console.log(error)
                toastShow(error.response.data.message, "error");
            }
        })
    </script>
</th:block>
</body>

</html>