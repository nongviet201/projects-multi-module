<!DOCTYPE html>
<html lang="en" th:replace="~{layout/layout :: layout(~{:: title}, ~{:: #css}, ~{:: .content-index}, ~{:: #js})}"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Admin Movie MetaData</title>

    <th:block id="css">
    </th:block>
</head>

<body class="hold-transition sidebar-mini layout-fixed">

<div class="wrapper">
    <div class="content-index">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-12">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/admin">Dashboard</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="/admin/movie/meta-data">Movie Data</a>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12 col-lg-8 col-xxl-6 d-flex">
                        <div class="card px-4 pb-4 flex-fill">
                            <div class="card-header d-flex justify-content-between px-0">
                                <div class="card-title mb-0 me-2">Danh sách diễn viên</div>
                                <div>
                                    <button class="btn btn-success"
                                            type="button" onclick="create('actor')">
                                        <i class="fa-solid fa-plus"></i> Tạo mới
                                    </button>
                                </div>
                            </div>
                            <table class="table table-hover my-0" id="table-actor">
                                <thead>
                                <tr>
                                    <th class="text-center">Tên</th>
                                    <th class="text-center">Edit</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="actor : ${actors}">
                                    <td>
                                        <span th:id="'actor-' + ${actor.id}">[[${actor.name}]]</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" type="button"
                                                th:value="${actor.id}"
                                                th:attr="data-type='actor'"
                                                onclick="edit(this)">
                                            <i class="fa-regular fa-pen-to-square"></i> Sửa
                                        </button>
                                        <button class="btn btn-danger" type="button"
                                                th:value="${actor.id}"
                                                th:attr="data-type='actor'"
                                                onclick="deleteMetadata(this)">
                                            <i class="fa-regular fa-trash-can"></i> Xóa
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-12 col-lg-8 col-xxl-6 d-flex">
                        <div class="card px-4 pb-4 flex-fill">
                            <div class="card-header d-flex justify-content-between px-0">
                                <div class="card-title mb-0 me-2">Danh sách đạo diễn</div>
                                <div>
                                    <button class="btn btn-success"
                                            type="button" onclick="create('director')">
                                        <i class="fa-solid fa-plus"></i> Tạo mới
                                    </button>
                                </div>
                            </div>
                            <table class="table table-hover my-0" id="table-director">
                                <thead>
                                <tr>
                                    <th class="text-center">Tên</th>
                                    <th class="text-center">Edit</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="director : ${directors}">
                                    <td>
                                        <span th:id="'director-' + ${director.id}">[[${director.name}]]</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" type="button"
                                                th:value="${director.id}"
                                                th:attr="data-type='director'"
                                                onclick="edit(this)">
                                            <i class="fa-regular fa-pen-to-square"></i> Sửa
                                        </button>
                                        <button class="btn btn-danger" type="button"
                                                th:value="${director.id}"
                                                th:attr="data-type='director'"
                                                onclick="deleteMetadata(this)">
                                            <i class="fa-regular fa-trash-can"></i> Xóa
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-12 col-lg-8 col-xxl-6 d-flex">
                        <div class="card px-4 pb-4 flex-fill">
                            <div class="card-header d-flex justify-content-between px-0">
                                <div class="card-title mb-0 me-2">Danh sách thể loại</div>
                                <div>
                                    <button class="btn btn-success"
                                            type="button" onclick="create('genre')">
                                        <i class="fa-solid fa-plus"></i> Tạo mới
                                    </button>
                                </div>
                            </div>
                            <table class="table table-hover my-0" id="table-genre">
                                <thead>
                                <tr>
                                    <th class="text-center">Tên</th>
                                    <th class="text-center">Edit</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="genre : ${genres}">
                                    <td>
                                        <span th:id="'genre-' + ${genre.id}">[[${genre.name}]]</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" type="button"
                                                th:value="${genre.id}"
                                                th:attr="data-type='genre'"
                                                onclick="edit(this)">
                                            <i class="fa-regular fa-pen-to-square"></i> Sửa
                                        </button>
                                        <button class="btn btn-danger" type="button"
                                                th:value="${genre.id}"
                                                th:attr="data-type='genre'"
                                                onclick="deleteMetadata(this)">
                                            <i class="fa-regular fa-trash-can"></i> Xóa
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-12 col-lg-8 col-xxl-6 d-flex">
                        <div class="card px-4 pb-4 flex-fill">
                            <div class="card-header d-flex justify-content-between px-0">
                                <div class="card-title mb-0 me-2">Danh sách quốc gia</div>
                                <div>
                                    <button class="btn btn-success"
                                            type="button" onclick="create('country')">
                                        <i class="fa-solid fa-plus"></i> Tạo mới
                                    </button>
                                </div>
                            </div>
                            <table class="table table-hover my-0" id="table-country">
                                <thead>
                                <tr>
                                    <th class="text-center">Tên</th>
                                    <th class="text-center">Edit</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="country : ${countries}">
                                    <td>
                                        <span th:id="'country-' + ${country.id}">[[${country.name}]]</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary" type="button"
                                                th:value="${country.id}"
                                                th:attr="data-type='country'"
                                                onclick="edit(this)">
                                            <i class="fa-regular fa-pen-to-square"></i> Sửa
                                        </button>
                                        <button class="btn btn-danger" type="button"
                                                th:value="${country.id}"
                                                th:attr="data-type='country'"
                                                onclick="deleteMetadata(this)">
                                            <i class="fa-regular fa-trash-can"></i> Xóa
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div aria-hidden="true" class="modal fade" id="modal" style="display: none;" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title fw-bold text-center">Tạo mới</h3>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                        </div>
                        <div class="modal-body m-3">
                            <label id="label-name" for="name"></label>
                            <input id="name" name="name" type="text" class="form-control">
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Đóng</button>
                            <button id="create" class="btn btn-success" type="button">Tạo mới</button>
                            <button id="edit" class="btn btn-success" type="button">Lưu thay đổi</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
<th:block id="js">

    <script type="text/javascript">

        async function create(type) {

            $('#modal').modal('show');
            document.getElementById('create').classList.remove('d-none');
            document.getElementById('edit').classList.add('d-none');

            document.getElementById('label-name').innerHTML = `New <strong>${type}</strong> name`;
            document.getElementById('name').value = "";

            document.getElementById('create').onclick = async function () {
                const name = document.getElementById('name').value;

                if (name.trim() === '') {
                    toastShow('Tên không được để trống', 'error');
                    return;
                }

                const data = {
                    name: name.trim(),
                    type: type
                };

                try {
                    const res = await axios.post('/admin/api/v1/movie/meta-data/create', data);
                    toastShow(`Tạo mới ${type} thành công`, 'success');
                    $('#createModal').modal('hide');
                    setTimeout(() => {
                        location.reload();
                    }, 1500)
                } catch (e) {
                    toastShow('e.response.data.message', 'error');
                }
            }
        }

        async function edit(button) {

            $('#modal').modal('show');

            const id = button.value;
            const type = button.getAttribute('data-type');

            document.getElementById('create').classList.add('d-none');
            document.getElementById('edit').classList.remove('d-none');

            document.getElementById('label-name').innerHTML = `Edit <strong>${type}</strong> name`;
            document.getElementById('name').value = document.getElementById(`${type}-${id}`).innerText;

            document.getElementById('edit').onclick = async function () {
                const name = document.getElementById('name').value;

                if (name.trim() === '') {
                    toastShow('Tên không được để trống', 'error');
                    return;
                }

                const data = {
                    name: name.trim(),
                    type: type
                };

                try {
                    const res = await axios.put(`/admin/api/v1/movie/meta-data/edit/${id}`, data);
                    toastShow(`Đã cập nhật ${type}`, 'success');
                    $('#createModal').modal('hide');
                    setTimeout(() => {
                        location.reload();
                    }, 2000)
                } catch (e) {
                    toastShow('e.response.data.message', 'error');
                }
            }
        }

        async function deleteMetadata(button) {
            const id = button.value;
            const type = button.getAttribute('data-type');

            try {
                const res = await axios.delete(`/admin/api/v1/movie/meta-data/${id}/${type}`);
                toastShow(`Đã xóa ${type} thành công`, "success");
                setTimeout(() => {
                    window.location.href = "/admin/movie/meta-data";
                }, 1000);
            } catch (error) {
                console.log(error);
                toastShow(error.response.data.message, "error");
            }
        }
    </script>

    <script>
        dataTableSettings('#table-actor');
        dataTableSettings('#table-director');
        dataTableSettings('#table-genre');
        dataTableSettings('#table-country');

        function dataTableSettings(element) {
            $(element).DataTable({
                "lengthChange": true,
                "lengthMenu": [5, 10, 25, 50, 100],
                "language": languageTable,
                "createdRow": function (row, data, dataIndex) {
                    $('td', row).eq(0).addClass('text-start');
                    $('td', row).eq(1).addClass('text-end');
                },
            });
        }
    </script>
</th:block>

</body>
</html>